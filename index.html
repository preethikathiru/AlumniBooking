<!DOCTYPE html>
<html>

<head>
    <title>Student</title>
</head>

<body>
    <input type="button" onclick="listalumni()" value="alumnilist" id="showlist">
    <p id="showData"></p>

    <script>
        var col = [];
        var globalalumni;
        function JsontoHtml(alumni) {
            for (var i = 0; i < alumni.length; i++) {
                for (var key in alumni[i]) {
                    if (col.indexOf(key) === -1) {
                        col.push(key);
                    }

                }
            }
            //col.push('date')

            var table = document.createElement("table");
            var tr = table.insertRow(-1);                   // TABLE ROW.
            for (var i = 0; i < col.length; i++) {
                var th = document.createElement("th");      // TABLE HEADER.
                th.innerHTML = col[i];
                tr.appendChild(th);


            }


            for (var i = 0; i < alumni.length; i++) {

                tr = table.insertRow(-1);

                for (var j = 0; j < col.length; j++) {
                    var tabCell = tr.insertCell(-1);
                    tabCell.innerHTML = alumni[i][col[j]];

                }
                var textbox = document.createElement("INPUT");
                textbox.type = "Date";
                tr.appendChild(textbox);

                td1 = document.createElement("td")
                var button = document.createElement('input');
                button.setAttribute('type', 'button');
                button.setAttribute('value', 'BOOK');
                button.setAttribute('onclick', 'bookslot(this)');
                console.log('Hello123')
                td1.appendChild(button);
                tr.appendChild(td1);
                console.log('Hello123')

            }
            var divContainer = document.getElementById("showData");
            divContainer.innerHTML = "";
            divContainer.appendChild(table);
        }

        function listalumni() {
            const url = 'http://localhost:4000/getalumni';
            fetch(url).then(res => {
                return res.json();
            }).then(alumni => {
                console.log(alumni)
                JsontoHtml(alumni)
                globalalumni = alumni
            })
                .catch(err => {
                    console.log(err)
                })
        }
        function bookslot(obj) {

            var par = obj.parentNode;
            while (par.nodeName.toLowerCase() != 'tr') {
                par = par.parentNode;
            }
            var index = par.rowIndex;
            console.log(globalalumni[index], 'using index')
            table = document.getElementsByTagName("table");
            input = table[0].rows.item(index).getElementsByTagName("input");
            console.log(input[0].value)
            dataToBookApi = globalalumni[index];
            dataToBookApi.date = input[0].value;
            var datafetch = JSON.stringify(dataToBookApi);
            console.log(JSON.stringify(dataToBookApi), 'dataToBookApi')
            console.log(datafetch, 'final')

            fetch("http://localhost:4000/bookslot", {
                method: "POST",
                body: JSON.stringify(datafetch)
            })
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    console.log(datafetch)
                })
                .catch( err => {
                    console.log(err)
                })

        }



    </script>
</body>